<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Lernmodule ‚Äì Video, Quiz, Erkl√§rung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 20px;
        }

        #video,
        #quiz,
        #explanation,
        #pixelBoard {
            display: none;
            margin-top: 20px;
        }

        .question {
            margin-bottom: 16px;
        }

        button {
            padding: 8px 12px;
        }

        .score {
            margin-top: 10px;
            color: #0b5;
        }

        #pixelBoard {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
        }

        .pixel-tools {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        #pixelPalette button {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        #pixelGrid {
            display: grid;
            gap: 2px;
            justify-content: start;
            margin-bottom: 16px;
        }

        .pixel-cell {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #f4f4f4;
            cursor: crosshair;
            transition: transform 0.1s ease;
        }

        .pixel-cell:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <h1>Lernmodule</h1>

    <div id="moduleInfo"></div>

    <div id="linkBlock" style="display:none; margin-top:20px;">
        <h2>Material</h2>
        <p>
            Bitte √∂ffne den Link unten.
            Das Quiz startet automatisch in <span id="timer">60</span> Sekunden.
        </p>
        <p>
            <a id="resourceLink" href="#" target="_blank">Link √∂ffnen</a>
        </p>
    </div>

    <div id="video">
        <video id="videoPlayer" width="720" controls></video>
    </div>

    <div id="pixelBoard">
        <h2>Pixel-Spielplatz</h2>
        <p>Male dein eigenes Pixel-Kunstwerk. Danach geht es weiter mit dem Quiz.</p>
        <div class="pixel-tools">
            <strong>Farben:</strong>
            <div id="pixelPalette"></div>
            <button id="pixelClear">Zur√ºcksetzen</button>
        </div>
        <div id="pixelGrid"></div>
        <button id="pixelStartQuiz">Zum Quiz</button>
    </div>

    <div id="quiz">
        <h2>Quiz</h2>
        <div id="quizContent"></div>
        <button id="submitQuiz">Antworten pr√ºfen & speichern</button>
        <div id="result" class="score"></div>
    </div>

    <div id="explanation">
        <h2>Erkl√§rung</h2>
        <p id="explanationText"></p>
        <button id="nextModule">N√§chstes Modul</button>
    </div>

    <script>
        const modules = [
            { video: "videos/Video1.mp4", quiz: "quizzes/quiz1.json", explanation: "Das war die Erkl√§rung zum ersten Quiz." },
            { video: null, quiz: "quizzes/quiz2.json", explanation: "Hier die Erkl√§rung zum zweiten Quiz." },
            {
                pixelBoard: {
                    size: 16,
                    palette: ["#111111", "#ff4757", "#ffa801", "#1e90ff", "#2ed573", "#ffffff"]
                },
                quiz: "quizzes/quiz2.json",
                explanation: "Hier die Erkl√§rung zum zweiten Quiz."
            },
            {
                link: "https://www.pixilart.com/draw",
                quiz: "quizzes/quiz2.json",
                explanation: "Hier die Erkl√§rung zum zweiten Quiz."
            }
        ];

        let currentModule = 0;
        let currentQuestions = [];
        let timerInterval = null;
        let pixelConfig = null;
        let pixelBoardQuizFile = null;
        let currentColor = "#111111";
        let mouseDown = false;
        const defaultApiBaseUrl = "http://localhost:5017";
        const apiBaseUrl = window.location.origin.startsWith("http")
            ? window.location.origin
            : defaultApiBaseUrl;

        function setVisible(section) {
            document.getElementById("linkBlock").style.display = section === "link" ? "block" : "none";
            document.getElementById("video").style.display = section === "video" ? "block" : "none";
            document.getElementById("pixelBoard").style.display = section === "pixel" ? "block" : "none";
            document.getElementById("quiz").style.display = section === "quiz" ? "block" : "none";
            document.getElementById("explanation").style.display = section === "explanation" ? "block" : "none";
        }

        function loadModule(index) {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            const m = modules[index];
            if (!m) {
                document.body.innerHTML = "<h2>Alle Module abgeschlossen üéâ</h2><p>Ergebnisse kannst du unter /api/quiz/runs abrufen.</p>";
                return;
            }

            document.getElementById("moduleInfo").textContent = `Modul ${index + 1} von ${modules.length}`;

            if (m.video) {
                setVisible("video");
                const player = document.getElementById("videoPlayer");
                player.src = m.video;
                player.onended = () => showQuiz(m.quiz);
            } else if (m.pixelBoard) {
                startPixelBoard(m.pixelBoard, m.quiz);
            } else if (m.link) {
                startLinkTimer(m.link, m.quiz);
            } else {
                showQuiz(m.quiz);
            }
        function startPixelBoard(config, quizFile) {
            pixelConfig = config;
            pixelBoardQuizFile = quizFile;
            currentColor = config.palette?.[0] ?? "#111111";
            buildPixelPalette(config.palette ?? ["#111111", "#ffffff"]);
            buildPixelGrid(config.size ?? 16);
            setVisible("pixel");

            document.getElementById("pixelStartQuiz").onclick = () => showQuiz(pixelBoardQuizFile);
            document.getElementById("pixelClear").onclick = clearPixelBoard;
        }

        function buildPixelPalette(palette) {
            const paletteContainer = document.getElementById("pixelPalette");
            paletteContainer.innerHTML = "";
            palette.forEach(color => {
                const button = document.createElement("button");
                button.style.background = color;
                button.title = color;
                button.onclick = () => currentColor = color;
                paletteContainer.appendChild(button);
            });
        }

        function buildPixelGrid(size) {
            const grid = document.getElementById("pixelGrid");
            grid.innerHTML = "";
            grid.style.gridTemplateColumns = `repeat(${size}, 24px)`;
            grid.style.gridTemplateRows = `repeat(${size}, 24px)`;

            for (let i = 0; i < size * size; i++) {
                const cell = document.createElement("div");
                cell.className = "pixel-cell";
                cell.dataset.index = i;
                cell.onmousedown = () => paintCell(cell);
                cell.onmouseover = (e) => {
                    if (mouseDown) {
                        paintCell(cell);
                    }
                };
                grid.appendChild(cell);
            }
        }

        function paintCell(cell) {
            cell.style.background = currentColor;
            cell.dataset.color = currentColor;
        }

        function clearPixelBoard() {
            document.querySelectorAll(".pixel-cell").forEach(cell => {
                cell.style.background = "#f4f4f4";
                delete cell.dataset.color;
            });
        }

        document.addEventListener("mousedown", () => { mouseDown = true; });
        document.addEventListener("mouseup", () => { mouseDown = false; });

        }
        function startVideo(videoSrc, quizFile) {
            setVisible("video");
            const player = document.getElementById("videoPlayer");
            player.src = videoSrc;
            player.onended = () => showQuiz(quizFile);
        }

        function startLinkTimer(url, quizFile) {
    setVisible("link");

    const timerDisplay = document.getElementById("timer");
    const openBtn = document.getElementById("openLinkBtn");

    let timeLeft = 60;
    timerDisplay.textContent = timeLeft;
    openedWindow = null;

    openBtn.onclick = () => {
        if (!openedWindow || openedWindow.closed) {
            openedWindow = window.open(url, "_blank", "noopener");
        }
    };

    if (timerInterval) {
        clearInterval(timerInterval);
    }

    timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;

            if (openedWindow && !openedWindow.closed) {
                openedWindow.close();
            }

            showQuiz(quizFile);
        }
    }, 1000);
}

        async function showQuiz(quizFile) {
            setVisible("quiz");
            document.getElementById("result").textContent = "";
            const res = await fetch(quizFile);
            currentQuestions = await res.json();

            const quizContent = document.getElementById("quizContent");
            quizContent.innerHTML = "";
            currentQuestions.forEach((q, i) => {
                const div = document.createElement("div");
                div.className = "question";
                const optionsHtml = q.options.map((opt, j) =>
                    `<label><input type="radio" name="q${i}" value="${j}"> ${opt}</label>`
                ).join("<br>");
                div.innerHTML = `<p><strong>Frage ${i + 1}:</strong> ${q.question}</p>${optionsHtml}`;
                quizContent.appendChild(div);
            });

            document.getElementById("submitQuiz").onclick = submitQuizAnswers;
        }

        async function submitQuizAnswers() {
            const answers = currentQuestions.map((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                return {
                    question: q.question,
                    selectedIndex: selected ? parseInt(selected.value, 10) : null,
                    correctIndex: q.answer
                };
            });

            const payload = { module: currentModule, answers };
            const resultElement = document.getElementById("result");

            try {
                await fetch(`${apiBaseUrl}/api/quiz/result`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (err) {
                console.warn("Server konnte nicht speichern, benutze lokale Auswertung.");
            }

            showExplanation(modules[currentModule].explanation);
        }

        function showExplanation(text) {
            setVisible("explanation");
            document.getElementById("explanationText").textContent = text;

            document.getElementById("nextModule").onclick = () => {
                currentModule++;
                loadModule(currentModule);
            };
        }

        loadModule(currentModule);
    </script>
</body>
</html>